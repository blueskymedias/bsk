<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning & Exam Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header .user-info {
            font-size: 1rem;
            font-weight: 400;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        .auth-container, .admin-dashboard, .exam-container, .dashboard, .learning-page {
            max-width: 900px;
            margin: 40px auto;
            padding: 30px;
            border-radius: 15px;
            background: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .auth-container:hover, .admin-dashboard:hover, .exam-container:hover, .dashboard:hover, .learning-page:hover {
            transform: translateY(-5px);
        }

        h2 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        h3 {
            font-size: 1.5rem;
            color: #34495e;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            font-weight: 500;
        }

        button {
            background: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background 0.3s ease, transform 0.1s ease;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .dashboard, .learning-page, .exam-container, .admin-dashboard {
            display: none;
        }

        .admin-section {
            margin-top: 30px;
        }

        .user-card, .exam-user-card, .result-card, .request-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .user-card:hover, .exam-user-card:hover, .result-card:hover, .request-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .user-card p, .exam-user-card p, .result-card p, .request-card p {
            font-size: 0.95rem;
            color: #7f8c8d;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .admin-dashboard .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .error {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 0.9rem;
            text-align: center;
            display: none;
        }

        .empty-message {
            text-align: center;
            color: #95a5a6;
            font-size: 1rem;
            font-style: italic;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input, select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }

        /* Category Cards Styling */
        .categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .category-card {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .category-card:hover:not(.locked) {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .category-card.locked {
            background: #f0f0f0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .category-card h4 {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .category-card p {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        /* Exam Section Styling */
        .exam-container {
            background: linear-gradient(145deg, #ffffff, #e6e9f0);
            padding: 40px;
        }

        .exam-header {
            background: #3498db;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .exam-header p {
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .timer {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e74c3c;
            text-align: center;
            margin: 20px 0;
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .question {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .question:hover {
            transform: translateY(-3px);
        }

        .question p {
            font-size: 1.1rem;
            color: #34495e;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .question label {
            display: block;
            margin: 10px 0;
            font-size: 1rem;
            color: #7f8c8d;
            cursor: pointer;
        }

        .question input[type="radio"] {
            margin-right: 10px;
            accent-color: #3498db;
        }

        .exam-container button {
            background: #2ecc71;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 20px;
            width: 100%;
        }

        .exam-container button:hover {
            background: #27ae60;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .auth-container, .admin-dashboard, .exam-container, .dashboard, .learning-page {
                padding: 20px;
            }

            h2 {
                font-size: 1.5rem;
            }

            h3 {
                font-size: 1.2rem;
            }

            button {
                padding: 10px;
                font-size: 0.9rem;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .header .user-info {
                font-size: 0.9rem;
            }

            .category-card {
                padding: 15px;
            }

            .category-card h4 {
                font-size: 1rem;
            }

            .exam-header {
                padding: 15px;
            }

            .exam-header p {
                font-size: 0.9rem;
            }

            .timer {
                font-size: 1rem;
            }

            .question p {
                font-size: 1rem;
            }

            .question label {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header">
        <h1>Learning & Exam Portal</h1>
        <div class="user-info" id="user-info">Welcome, Guest</div>
    </div>

    <div class="container">
        <!-- Authentication Section -->
        <div id="auth" class="auth-container">
            <h2 id="auth-title">Register</h2>
            <form id="auth-form">
                <input type="email" id="email" name="email" placeholder="Email" required>
                <input type="text" id="username" name="username" placeholder="Username" required>
                <input type="text" id="college_roll_number" name="college_roll_number" placeholder="College Roll Number" required>
                <input type="text" id="college_name" name="college_name" placeholder="College Name" required>
                <input type="text" id="group_name" name="group_name" placeholder="Group Name" required>
                <select id="selected_course" name="selected_course" required>
                    <option value="" selected>Select a Course</option>
                    <option value="Python">Python</option>
                    <option value="AI">AI</option>
                    <option value="C">C</option>
                    <option value="Java">Java</option>
                    <option value="HTML">HTML</option>
                    <option value="CSS">CSS</option>
                </select>
                <input type="password" id="password" name="password" placeholder="Password" required>
                <input type="text" id="exam_user_id" name="exam_user_id" placeholder="Exam User ID" style="display: none;">
                <button type="submit" id="submit-btn">Submit</button>
                <p><a href="#" id="toggle-auth">Switch to Login</a> | <a href="#" id="toggle-exam">Exam Login</a></p>
                <div id="auth-error" class="error"></div>
            </form>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="dashboard">
            <h2>Welcome to Skill Share</h2>
            <button onclick="showAdminDashboard()" id="admin-btn" style="display: none;">Admin Dashboard</button>
            <div id="categories" class="categories"></div>
            <div id="user-attendance" class="attendance-section"></div>
        </div>

        <!-- Learning Page -->
        <div id="learning-page" class="learning-page">
            <h2>Learning: <span id="learning-category"></span></h2>
            <button onclick="backToDashboard()">Back to Dashboard</button>
            <button onclick="requestAttendance()">Request Attendance</button>
            <div id="video-page" class="video-page"></div>
            <button id="next-btn" onclick="nextVideo()" style="display: none;">Next Video</button>
            <div id="learning-error" class="error"></div>
        </div>

        <!-- Exam Section -->
        <div id="exam-container" class="exam-container">
            <div class="exam-header" id="exam-user-details">
                <p><strong>Name:</strong> Loading...</p>
                <p><strong>Email:</strong> Loading...</p>
                <p><strong>Exam User ID:</strong> Loading...</p>
            </div>
            <h2>Exam</h2>
            <div id="timer" class="timer">Time Left: 20:00</div>
            <div id="questions"></div>
            <button onclick="submitExam()">Submit Exam</button>
            <div id="exam-error" class="error"></div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="admin-dashboard">
            <h2>Admin Dashboard</h2>
            <div class="button-group">
                <button onclick="backToDashboard()">Back to User Dashboard</button>
                <button onclick="showGenerateExamUserForm()">Generate Exam User</button>
            </div>
            <div id="exam-user-form" style="display: none; margin-top: 20px;">
                <h3>Create Exam User</h3>
                <form id="generate-exam-user-form">
                    <input type="text" id="exam-user-id" name="exam_user_id" placeholder="User ID (auto-generated)" readonly>
                    <input type="text" id="exam-name" name="name" placeholder="Name" required>
                    <input type="text" id="exam-username" name="username" placeholder="Username" required>
                    <input type="text" id="exam-user-email" name="email" placeholder="User Email" required>
                    <input type="password" id="exam-password" name="password" placeholder="Password" required>
                    <button type="submit">Create Exam User</button>
                    <div id="exam-user-error" class="error"></div>
                </form>
            </div>
            <div id="registered-users" class="users-section admin-section">
                <h3>Registered Users</h3>
            </div>
            <div id="exam-users" class="exam-users-section admin-section">
                <h3>Created Exam Users</h3>
            </div>
            <div id="exam-results" class="results-section admin-section">
                <h3>Exam Results</h3>
            </div>
            <div id="attendance-requests" class="attendance-section admin-section">
                <h3>Pending Attendance Requests</h3>
            </div>
            <div id="admin-attendance" class="attendance-section admin-section">
                <h3>Confirmed Attendance</h3>
            </div>
            <div id="admin-error" class="error"></div>
        </div>
    </div>

    <script>
        let token = null;
        let isAdmin = false;
        let isExam = false;
        let currentCategory = null;
        let videos = [];
        let currentVideoIndex = 0;
        let timeLeft = 1200; // 20 minutes for exam
        let userDetails = null; // To store user details after login

        document.addEventListener('DOMContentLoaded', () => {
            const authForm = document.getElementById('auth-form');
            const emailInput = document.getElementById('email');
            const examUserIdInput = document.getElementById('exam_user_id');
            const usernameInput = document.getElementById('username');
            const collegeRollNumberInput = document.getElementById('college_roll_number');
            const collegeNameInput = document.getElementById('college_name');
            const groupNameInput = document.getElementById('group_name');
            const courseSelect = document.getElementById('selected_course');
            const authError = document.getElementById('auth-error');

            function updateRequiredFields() {
                emailInput.removeAttribute('required');
                examUserIdInput.removeAttribute('required');
                usernameInput.removeAttribute('required');
                collegeRollNumberInput.removeAttribute('required');
                collegeNameInput.removeAttribute('required');
                groupNameInput.removeAttribute('required');
                courseSelect.removeAttribute('required');
                document.getElementById('password').removeAttribute('required');

                if (document.getElementById('auth-title').textContent === 'Login' && !isExam) {
                    emailInput.setAttribute('required', '');
                    document.getElementById('password').setAttribute('required', '');
                } else if (document.getElementById('auth-title').textContent === 'Register' && !isExam) {
                    emailInput.setAttribute('required', '');
                    usernameInput.setAttribute('required', '');
                    collegeRollNumberInput.setAttribute('required', '');
                    collegeNameInput.setAttribute('required', '');
                    groupNameInput.setAttribute('required', '');
                    courseSelect.setAttribute('required', '');
                    document.getElementById('password').setAttribute('required', '');
                } else if (isExam) {
                    examUserIdInput.setAttribute('required', '');
                    document.getElementById('password').setAttribute('required', '');
                }
            }

            function updateFormVisibility() {
                const isLogin = document.getElementById('auth-title').textContent === 'Login';
                emailInput.style.display = 'block';
                examUserIdInput.style.display = 'none';
                usernameInput.style.display = isLogin ? 'none' : 'block';
                collegeRollNumberInput.style.display = isLogin ? 'none' : 'block';
                collegeNameInput.style.display = isLogin ? 'none' : 'block';
                groupNameInput.style.display = isLogin ? 'none' : 'block';
                courseSelect.style.display = isLogin ? 'none' : 'block';
            }

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                updateRequiredFields();
                const email = emailInput.value.trim();
                const exam_user_id = examUserIdInput.value.trim();
                const password = document.getElementById('password').value.trim();
                const username = usernameInput.value.trim();
                const college_roll_number = collegeRollNumberInput.value.trim();
                const college_name = collegeNameInput.value.trim();
                const group_name = groupNameInput.value.trim();
                const selected_course = courseSelect.value;

                authError.style.display = 'none';

                if (isExam) {
                    const res = await fetch('http://localhost:5000/exam/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ exam_user_id, password })
                    });
                    const data = await res.json();
                    if (data.token) {
                        token = data.token;
                        userDetails = {
                            username: data.username || 'Exam User',
                            name: data.name || 'Exam User',
                            email: data.email || 'N/A',
                            exam_user_id: exam_user_id
                        };
                        document.getElementById('user-info').textContent = `Welcome, ${userDetails.username}`;
                        startExam();
                    }
                    authError.textContent = data.message || 'Login failed';
                    authError.style.display = 'block';
                } else {
                    const endpoint = document.getElementById('auth-title').textContent === 'Login' ? '/login' : '/register';
                    const body = endpoint === '/login' ? { email, password } : {
                        email,
                        password,
                        username,
                        college_roll_number,
                        college_name,
                        group_name,
                        selected_course
                    };
                    
                    const res = await fetch(`http://localhost:5000${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    if (data.token) {
                        token = data.token;
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        isAdmin = payload.is_admin || false;
                        userDetails = {
                            username: username || payload.username || 'User',
                            name: payload.name || username || 'User',
                            email: email,
                            college_roll_number,
                            college_name,
                            group_name,
                            selected_course
                        };
                        document.getElementById('user-info').textContent = `Welcome, ${userDetails.username}`;
                        showDashboard();
                    }
                    authError.textContent = data.message || 'Registration/Login failed';
                    authError.style.display = 'block';
                }
            });

            document.getElementById('toggle-auth').addEventListener('click', () => {
                const isLogin = document.getElementById('auth-title').textContent === 'Login';
                document.getElementById('auth-title').textContent = isLogin ? 'Register' : 'Login';
                document.getElementById('toggle-auth').textContent = isLogin ? 'Switch to Login' : 'Switch to Register';
                isExam = false;
                document.getElementById('toggle-exam').textContent = 'Exam Login';
                updateFormVisibility();
                updateRequiredFields();
                authError.style.display = 'none';
            });

            document.getElementById('toggle-exam').addEventListener('click', () => {
                isExam = !isExam;
                document.getElementById('auth-title').textContent = isExam ? 'Exam Login' : 'Login';
                document.getElementById('toggle-exam').textContent = isExam ? 'Regular Login' : 'Exam Login';
                emailInput.style.display = isExam ? 'none' : 'block';
                examUserIdInput.style.display = isExam ? 'block' : 'none';
                usernameInput.style.display = 'none';
                collegeRollNumberInput.style.display = 'none';
                collegeNameInput.style.display = 'none';
                groupNameInput.style.display = 'none';
                courseSelect.style.display = 'none';
                updateRequiredFields();
                authError.style.display = 'none';
            });

            function generateUniqueId() {
                return 'EXAM_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            }

            const examUserForm = document.getElementById('generate-exam-user-form');
            const examUserError = document.getElementById('exam-user-error');
            if (examUserForm) {
                examUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const exam_user_id = generateUniqueId();
                    const name = document.getElementById('exam-name').value.trim();
                    const username = document.getElementById('exam-username').value.trim();
                    const email = document.getElementById('exam-user-email').value.trim();
                    const password = document.getElementById('exam-password').value.trim();

                    if (!name || !username || !email || !password) {
                        examUserError.textContent = 'Please fill all fields.';
                        examUserError.style.display = 'block';
                        return;
                    }

                    examUserError.style.display = 'none';

                    const headers = { 'Content-Type': 'application/json' };
                    if (token) {
                        headers['Authorization'] = token;
                    } else {
                        examUserError.textContent = 'No token found. Please log in as admin.';
                        examUserError.style.display = 'block';
                        return;
                    }

                    try {
                        const res = await fetch('http://localhost:5000/admin/create_exam_user', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({ exam_user_id, name, username, email, password })
                        });

                        const data = await res.json();
                        if (!res.ok) {
                            throw new Error(data.message || `HTTP error! Status: ${res.status}`);
                        }

                        examUserError.textContent = `Exam User Created Successfully!`;
                        examUserError.style.display = 'block';
                        examUserForm.reset();
                        document.getElementById('exam-user-form').style.display = 'none';
                        showAdminDashboard();
                    } catch (error) {
                        console.error('Error creating exam user:', error);
                        examUserError.textContent = `Failed to create exam user: ${error.message}`;
                        examUserError.style.display = 'block';
                    }
                });
            }
        });

        async function showDashboard() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('learning-page').style.display = 'none';
            document.getElementById('exam-container').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('admin-btn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('auth-error').style.display = 'none';
            
            try {
                const catRes = await fetch('http://localhost:5000/categories', { 
                    headers: { 'Authorization': token } 
                });
                const catData = await catRes.json();
                const catDiv = document.getElementById('categories');
                catDiv.innerHTML = catData.categories.map(cat => `
                    <div class="category-card ${catData.selected_course === cat ? '' : 'locked'}" 
                         onclick="${catData.selected_course === cat ? `startLearning('${cat}')` : `alert('Course is locked. Only ${catData.selected_course} is available.')`}">
                        <h4>${cat}</h4>
                        <p>${catData.selected_course === cat ? 'Start Learning' : 'Locked'}</p>
                    </div>
                `).join('');
                
                const attRes = await fetch('http://localhost:5000/attendance', { 
                    headers: { 'Authorization': token } 
                });
                const attData = await attRes.json();
                const attDiv = document.getElementById('user-attendance');
                attDiv.innerHTML = '<h3>Your Attendance</h3>' + attData.attendance.map(a => `
                    <div class="request-card">
                        <p>Date: ${new Date(a.date).toLocaleString()}</p>
                        ${isAdmin ? `<p>Username: ${a.username}</p><p>Group: ${a.group_name}</p>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('auth-error').textContent = 'Failed to load dashboard. Please try again.';
                document.getElementById('auth-error').style.display = 'block';
            }
        }

        async function startLearning(category) {
            currentCategory = category;
            currentVideoIndex = 0;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('learning-page').style.display = 'block';
            document.getElementById('learning-error').style.display = 'none';
            
            try {
                const res = await fetch(`http://localhost:5000/learning/${category}`, { 
                    headers: { 'Authorization': token } 
                });
                const data = await res.json();
                if (data.message) {
                    document.getElementById('learning-error').textContent = data.message;
                    document.getElementById('learning-error').style.display = 'block';
                    backToDashboard();
                    return;
                }
                videos = data.videos;
                showVideo();
            } catch (error) {
                console.error('Error loading learning content:', error);
                document.getElementById('learning-error').textContent = 'Failed to load learning content. Please try again.';
                document.getElementById('learning-error').style.display = 'block';
            }
        }

        function showVideo() {
            const video = videos[currentVideoIndex];
            const videoDiv = document.getElementById('video-page');
            videoDiv.innerHTML = `
                <div class="video-card">
                    <h3>${video.title} (Video ${currentVideoIndex + 1} of ${videos.length})</h3>
                    <iframe src="${video.url}" allowfullscreen></iframe>
                    <p>${video.explanation}</p>
                </div>
            `;
            document.getElementById('next-btn').style.display = 
                currentVideoIndex < videos.length - 1 ? 'block' : 'none';
        }

        function nextVideo() {
            if (currentVideoIndex < videos.length - 1) {
                currentVideoIndex++;
                showVideo();
            }
        }

        async function requestAttendance() {
            try {
                const res = await fetch('http://localhost:5000/attendance/request', {
                    method: 'POST',
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                alert(data.message);
            } catch (error) {
                console.error('Error requesting attendance:', error);
                alert('Failed to request attendance. Please try again.');
            }
        }

        async function startExam() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('exam-container').style.display = 'block';
            document.getElementById('exam-error').style.display = 'none';

            // Display user details in the exam section
            if (userDetails) {
                const examUserDetails = document.getElementById('exam-user-details');
                examUserDetails.innerHTML = `
                    <p><strong>Name:</strong> ${userDetails.name}</p>
                    <p><strong>Email:</strong> ${userDetails.email}</p>
                    <p><strong>Exam User ID:</strong> ${userDetails.exam_user_id || 'N/A'}</p>
                `;
            }

            try {
                const res = await fetch('http://localhost:5000/exam/questions', {
                    headers: { 'Authorization': token }
                });
                const questions = await res.json();

                const questionsDiv = document.getElementById('questions');
                questionsDiv.innerHTML = ''; // Clear any existing content
                questions.forEach(q => {
                    questionsDiv.innerHTML += `
                        <div class="question">
                            <p>${q.question}</p>
                            ${q.options.map((opt, i) => `
                                <label>
                                    <input type="radio" name="q${q.question_id}" value="${String.fromCharCode(65+i)}">
                                    ${opt}
                                </label><br>
                            `).join('')}
                        </div>
                    `;
                });

                const timer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('timer').textContent = `Time Left: ${Math.floor(timeLeft/60)}:${timeLeft%60 < 10 ? '0' : ''}${timeLeft%60}`;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        submitExam();
                    }
                }, 1000);
            } catch (error) {
                console.error('Error starting exam:', error);
                document.getElementById('exam-error').textContent = 'Failed to load exam questions. Please try again.';
                document.getElementById('exam-error').style.display = 'block';
            }
        }

        async function submitExam() {
            const answers = [];
            document.querySelectorAll('.question').forEach(q => {
                const questionId = q.querySelector('input').name.slice(1);
                const selected = q.querySelector('input:checked');
                if (selected) answers.push({
                    question_id: parseInt(questionId),
                    answer: selected.value
                });
            });

            try {
                const res = await fetch('http://localhost:5000/exam/submit', {
                    method: 'POST',
                    headers: { 
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ answers })
                });
                const data = await res.json();
                document.getElementById('exam-error').textContent = `Exam completed! Score: ${data.score}/${data.total}`;
                document.getElementById('exam-error').style.display = 'block';
                setTimeout(() => location.reload(), 3000);
            } catch (error) {
                console.error('Error submitting exam:', error);
                document.getElementById('exam-error').textContent = 'Failed to submit exam. Please try again.';
                document.getElementById('exam-error').style.display = 'block';
            }
        }

        async function showAdminDashboard() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            document.getElementById('admin-error').style.display = 'none';
            
            try {
                // Fetch registered users
                const usersRes = await fetch('http://localhost:5000/admin/users', { 
                    headers: { 'Authorization': token } 
                });
                const usersData = await usersRes.json();
                const usersDiv = document.getElementById('registered-users');
                usersDiv.innerHTML = '<h3>Registered Users</h3>' + (usersData.users.length > 0 ? usersData.users.map(u => `
                    <div class="user-card">
                        <p><strong>User ID:</strong> ${u.id}</p>
                        <p><strong>Username:</strong> ${u.username}</p>
                        <p><strong>Email:</strong> ${u.email}</p>
                        <p><strong>College Roll Number:</strong> ${u.college_roll_number}</p>
                        <p><strong>College Name:</strong> ${u.college_name}</p>
                        <p><strong>Group:</strong> ${u.group_name}</p>
                        <p><strong>Selected Course:</strong> ${u.selected_course}</p>
                    </div>
                `).join('') : '<p class="empty-message">No registered users</p>');

                // Fetch created exam users
                const examUsersRes = await fetch('http://localhost:5000/admin/exam_users', { 
                    headers: { 'Authorization': token } 
                });
                const examUsersData = await examUsersRes.json();
                const examUsersDiv = document.getElementById('exam-users');
                examUsersDiv.innerHTML = '<h3>Created Exam Users</h3>' + (examUsersData.exam_users.length > 0 ? examUsersData.exam_users.map(u => `
                    <div class="exam-user-card">
                        <p><strong>Exam User ID:</strong> ${u.exam_user_id}</p>
                        <p><strong>Name:</strong> ${u.name}</p>
                        <p><strong>Username:</strong> ${u.username}</p>
                        <p><strong>Email:</strong> ${u.email}</p>
                        <p><strong>Created At:</strong> ${new Date(u.created_at).toLocaleString()}</p>
                    </div>
                `).join('') : '<p class="empty-message">No exam users created</p>');

                // Fetch exam results
                const examResultsRes = await fetch('http://localhost:5000/admin/exam_results', {
                    headers: { 'Authorization': token }
                });
                const examResultsData = await examResultsRes.json();
                const resultsDiv = document.getElementById('exam-results');
                resultsDiv.innerHTML = '<h3>Exam Results</h3>' + (examResultsData.results.length > 0 ? examResultsData.results.map(r => `
                    <div class="result-card">
                        <p><strong>Name:</strong> ${r.name}</p>
                        <p><strong>Email:</strong> ${r.email}</p>
                        <p><strong>Score:</strong> ${r.score}/${r.total_questions}</p>
                        <p><strong>Submission Time:</strong> ${new Date(r.submission_time).toLocaleString()}</p>
                    </div>
                `).join('') : '<p class="empty-message">No exam results available</p>');

                // Fetch attendance requests
                const reqRes = await fetch('http://localhost:5000/attendance/admin', { 
                    headers: { 'Authorization': token } 
                });
                const reqData = await reqRes.json();
                const reqDiv = document.getElementById('attendance-requests');
                reqDiv.innerHTML = '<h3>Pending Attendance Requests</h3>' + (reqData.requests.length > 0 ? reqData.requests.map(r => `
                    <div class="request-card">
                        <p><strong>User ID:</strong> ${r.user_id}</p>
                        <p><strong>Username:</strong> ${r.username}</p>
                        <p><strong>Group:</strong> ${r.group_name}</p>
                        <p><strong>Date:</strong> ${new Date(r.request_date).toLocaleString()}</p>
                        <button onclick="handleRequest(${r.request_id}, 'accept')">Accept</button>
                        <button onclick="handleRequest(${r.request_id}, 'reject')">Reject</button>
                    </div>
                `).join('') : '<p class="empty-message">No pending requests</p>');
                
                // Fetch confirmed attendance
                const attRes = await fetch('http://localhost:5000/attendance', { 
                    headers: { 'Authorization': token } 
                });
                const attData = await attRes.json();
                const attDiv = document.getElementById('admin-attendance');
                attDiv.innerHTML = '<h3>Confirmed Attendance</h3>' + (attData.attendance.length > 0 ? attData.attendance.map(a => `
                    <div class="request-card">
                        <p><strong>Username:</strong> ${a.username}</p>
                        <p><strong>Group:</strong> ${a.group_name}</p>
                        <p><strong>Date:</strong> ${new Date(a.date).toLocaleString()}</p>
                    </div>
                `).join('') : '<p class="empty-message">No confirmed attendance</p>');
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
                document.getElementById('admin-error').textContent = 'Failed to load admin dashboard. Please try again.';
                document.getElementById('admin-error').style.display = 'block';
            }
        }

        function showGenerateExamUserForm() {
            document.getElementById('exam-user-form').style.display = 'block';
            document.getElementById('exam-user-error').style.display = 'none';
        }

        async function handleRequest(requestId, action) {
            try {
                const res = await fetch('http://localhost:5000/attendance/admin', {
                    method: 'POST',
                    headers: { 
                        'Authorization': token, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ request_id: requestId, action })
                });
                const data = await res.json();
                alert(data.message);
                showAdminDashboard();
            } catch (error) {
                console.error('Error handling attendance request:', error);
                alert('Failed to handle attendance request. Please try again.');
            }
        }

        function backToDashboard() {
            document.getElementById('learning-page').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('exam-container').style.display = 'none';
            document.getElementById('learning-error').style.display = 'none';
            document.getElementById('admin-error').style.display = 'none';
            showDashboard();
        }
    </script>
</body>
</html>